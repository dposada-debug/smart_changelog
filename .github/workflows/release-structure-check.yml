name: Release Structure Check

on:
  release:
    types: [created, edited]

jobs:
  validate-release-structure:
    runs-on: ubuntu-latest

    steps:
      - name: Validate release body structure
        env:
          RELEASE_BODY: ${{ github.event.release.body }}
        run: |
          set -e

          echo "ğŸ” Validating release structure..."

          required_sections=(
            "## ğŸ§© What was deployed?"
            "## ğŸ¯ Customer impact"
            "## ğŸ‘€ Where will users notice it?"
            "## ğŸ—£ How can I explain this to a customer?"
            "## ğŸ¢ What other areas of the company does this affect?"
            "## ğŸ” Justification"
          )

          for section in "${required_sections[@]}"; do
            if ! echo "$RELEASE_BODY" | grep -qF "$section"; then
              echo "âŒ Missing required section: $section"
              echo "ğŸ‘‰ Please copy the template from .github/RELEASE_TEMPLATE.md"
              exit 1
            fi
          done

          echo "âœ… All required sections are present"

          # Explicit check: cross-team section must state impact or "No cross-team impact"
          if echo "$RELEASE_BODY" | grep -qF "## ğŸ¢ What other areas of the company does this affect?"; then
            SECTION_CONTENT=$(echo "$RELEASE_BODY" | awk '/## ğŸ¢ What other areas of the company does this affect\?/{flag=1;next}/## /{flag=0}flag')

            if ! echo "$SECTION_CONTENT" | grep -qi "no cross-team impact"; then
              echo "âŒ 'What other areas of the company does this affect?' must explicitly state impact or 'No cross-team impact'"
              exit 1
            fi
          fi

          echo "âœ… Release structure validation passed"
