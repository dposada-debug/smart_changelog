name: Release Structure Check

on:
  release:
    types: [created, edited]

jobs:
  validate-release-structure:
    runs-on: ubuntu-latest

    steps:
      - name: Validate release body structure
        env:
          RELEASE_BODY: ${{ github.event.release.body }}
        run: |
          set -e

          echo "ğŸ” Validating release structure..."

          required_sections=(
            "## ğŸ§© What was deployed?"
            "## ğŸ¯ Customer impact"
            "## ğŸ—£ How would you explain this to a customer?"
            "## ğŸ¢ Impact on other areas"
            "## ğŸ” Justification"
          )

          for section in "${required_sections[@]}"; do
            if ! echo "$RELEASE_BODY" | grep -q "$section"; then
              echo "âŒ Missing required section: $section"
              exit 1
            fi
          done

          echo "âœ… All required sections are present"

          # Ensure required sections are not empty
          echo "ğŸ” Checking that required sections are filled..."

          empty_markers=(
            "Describe \\*what changed\\*"
            "Explain \\*why this matters\\*"
            "Write this as if you were speaking"
            "Does this affect other teams"
            "Why was this change necessary"
          )

          for marker in "${empty_markers[@]}"; do
            if echo "$RELEASE_BODY" | grep -qi "$marker"; then
              echo "âŒ One or more required sections appear to be unfilled"
              exit 1
            fi
          done

          # Explicit check for Impact on other areas
          if echo "$RELEASE_BODY" | grep -q "## ğŸ¢ Impact on other areas"; then
            SECTION_CONTENT=$(echo "$RELEASE_BODY" | awk '/## ğŸ¢ Impact on other areas/{flag=1;next}/## /{flag=0}flag')

            if ! echo "$SECTION_CONTENT" | grep -qi "no cross-team impact"; then
              echo "âŒ 'Impact on other areas' must explicitly state 'No cross-team impact.' if none apply"
              exit 1
            fi
          fi

          echo "âœ… Release structure validation passed"
