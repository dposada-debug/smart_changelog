name: Release AI Review

on:
  release:
    types: [published, edited]

jobs:
  ai-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      improved_body_b64: ${{ steps.set-improved-output.outputs.improved_body_b64 }}

    steps:
      - name: Validate release with AI
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          RELEASE_BODY: ${{ github.event.release.body }}
        run: |
          set -euo pipefail

          echo "ü§ñ Running AI consistency review..."

          if [ -z "$RELEASE_BODY" ]; then
            echo "‚ùå Release body is empty"
            exit 1
          fi

          RESPONSE=$(curl -sS https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg content "$RELEASE_BODY" \
              '{
                model: "gpt-4o-mini",
                temperature: 0,
                messages: [
                  {
                    "role": "system",
                    "content": "You are a strict release reviewer. Score clarity, customer impact, justification, and cross-team impact."
                  },
                  {
                    "role": "user",
                    "content": "Review the following release notes. Respond ONLY with valid JSON in this format:\n{\n  \"score\": number (0-100),\n  \"verdict\": \"PASS\" or \"FAIL\",\n  \"issues\": [string]\n}\n\nRelease notes:\n\n\($content)"
                  }
                ]
              }')"
          )

          echo "AI raw response:"
          echo "$RESPONSE"

          # 1Ô∏è‚É£ Fail if OpenAI returns an error
          ERROR=$(echo "$RESPONSE" | jq -r '.error.message // empty')
          if [ -n "$ERROR" ]; then
            echo "‚ùå OpenAI API error:"
            echo "$ERROR"
            exit 1
          fi

          # 2Ô∏è‚É£ Extract AI message content
          AI_CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')
          if [ -z "$AI_CONTENT" ]; then
            echo "‚ùå AI response missing content"
            exit 1
          fi

          echo "Parsed AI content:"
          echo "$AI_CONTENT"

          # 3Ô∏è‚É£ Parse score safely
          SCORE=$(echo "$AI_CONTENT" | jq -r '.score // empty')
          VERDICT=$(echo "$AI_CONTENT" | jq -r '.verdict // empty')

          if ! [[ "$SCORE" =~ ^[0-9]+$ ]]; then
            echo "‚ùå Invalid or missing AI score: '$SCORE'"
            exit 1
          fi

          echo "AI score: $SCORE"
          echo "AI verdict: $VERDICT"

          # 4Ô∏è‚É£ Enforce 40% minimum score
          if [ "$SCORE" -lt 60 ]; then
            echo "‚ùå AI score too low ($SCORE < 60)"
            exit 1
          fi

          echo "‚úÖ AI review passed"

      - name: Improve release notes with AI
        id: improve
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          RELEASE_BODY: ${{ github.event.release.body }}
        run: |
          set -euo pipefail
          echo "ü§ñ Asking AI to correct and improve release notes..."
          RESPONSE=$(curl -sS https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg content "$RELEASE_BODY" \
              '{
                model: "gpt-4o-mini",
                temperature: 0.3,
                response_format: { type: "json_object" },
                messages: [
                  {
                    "role": "system",
                    "content": "You improve and correct release notes / changelogs. Preserve the author'\''s intent and structure (sections like What was deployed, Customer impact, etc.) but fix grammar, clarity, and tone. Make it more professional and customer-ready. Return ONLY a JSON object with a single key \"improved_body\" whose value is the full improved markdown string. No other keys. Escape newlines and quotes in the string as required for JSON."
                  },
                  {
                    "role": "user",
                    "content": "Improve these release notes:\n\n\($content)"
                  }
                ]
              }')"
          )
          ERROR=$(echo "$RESPONSE" | jq -r '.error.message // empty')
          if [ -n "$ERROR" ]; then
            echo "‚ùå OpenAI API error: $ERROR"
            exit 1
          fi
          IMPROVED_RAW=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')
          if [ -z "$IMPROVED_RAW" ]; then
            echo "‚ùå AI returned no content"
            exit 1
          fi
          echo "$IMPROVED_RAW" | jq -r '.improved_body' > improved_body.md
          echo "‚úÖ Improved release notes generated"

      - name: Update GitHub release with improved body
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_ID: ${{ github.event.release.id }}
        run: |
          set -euo pipefail
          BODY_JSON=$(jq -Rs . improved_body.md)
          curl -sSf -X PATCH \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/${{ github.repository }}/releases/${RELEASE_ID}" \
            -d "{\"body\": $BODY_JSON}"
          echo "‚úÖ Release body updated with AI-improved notes"

      - name: Set improved body output for next job
        id: set-improved-output
        run: |
          base64 -w0 improved_body.md >> improved_b64.txt
          echo "improved_body_b64<<EOF" >> $GITHUB_OUTPUT
          cat improved_b64.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  push-to-external-repo:
    needs: ai-review
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout external repository
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.EXTERNAL_REPO }}
          token: ${{ secrets.EXTERNAL_REPO_TOKEN }}
          fetch-depth: 0

      - name: Create release notes file
        env:
          IMPROVED_BODY_B64: ${{ needs.ai-review.outputs.improved_body_b64 }}
        run: |
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          NOTES_DIR="releases"
          mkdir -p "$NOTES_DIR"
          FILE_PATH="${NOTES_DIR}/${RELEASE_TAG}.md"
          echo "$IMPROVED_BODY_B64" | base64 -d > improved_body.md
          {
            echo "# Release ${RELEASE_TAG}"
            echo ""
            echo "**Published:** ${{ github.event.release.published_at }}"
            echo ""
            echo "---"
            echo ""
            cat improved_body.md
          } > "$FILE_PATH"
          echo "Created $FILE_PATH"

      - name: Commit and push to external repository
        run: |
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "releases/${RELEASE_TAG}.md"
          git diff --staged --quiet && echo "No changes to commit" || {
            git commit -m "chore: add release notes for ${RELEASE_TAG}"
            git push origin HEAD
          }
