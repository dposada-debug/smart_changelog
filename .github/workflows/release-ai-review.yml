name: Release AI Review

on:
  release:
    types: [created, edited]

jobs:
  ai-review:
    runs-on: ubuntu-latest

    steps:
      - name: Extract release body
        id: release
        run: |
          echo "BODY<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.release.body }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: AI consistency and clarity review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          RELEASE_BODY: ${{ steps.release.outputs.BODY }}
        run: |
          set -e

          echo "ü§ñ Running AI consistency review..."

          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "model": "gpt-4.1-mini",
              "temperature": 0.2,
              "messages": [
                {
                  "role": "system",
                  "content": "You are an AI reviewer evaluating software release explanations for customer clarity, consistency, and usefulness."
                },
                {
                  "role": "user",
                  "content": "Review the release explanation below using these rules:\n\n1. The explanation must be understandable by a non-technical customer.\n2. \"What was deployed\" and \"Customer impact\" must describe the same change.\n3. \"How would you explain this to a customer\" must be usable by Support.\n4. Flag major inconsistencies, contradictions, or meaningless text.\n\nReturn ONLY valid JSON with:\n- score: number from 0 to 100\n- verdict: PASS or FAIL\n- major_issues: array of strings\n- suggestions: array of strings\n\nRelease:\n\n'"$RELEASE_BODY"'"
                }
              ]
            }')

          echo "AI raw response:"
          echo "$RESPONSE"

          CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')

          SCORE=$(echo "$CONTENT" | jq '.score')
          VERDICT=$(echo "$CONTENT" | jq -r '.verdict')

          echo "AI score: $SCORE"
          echo "AI verdict: $VERDICT"

          if [ "$SCORE" -lt 40 ] || [ "$VERDICT" = "FAIL" ]; then
            echo "‚ùå AI review failed (minimum score is 40)"
            echo "Issues:"
            echo "$CONTENT" | jq -r '.major_issues[]?'
            exit 1
          fi

          echo "‚úÖ AI review passed"
